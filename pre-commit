#!/usr/bin/env bash

# Git pre-commit hook to enforce static analysis
# Runs ktlint and detekt before allowing commit

set -euo pipefail

RED="\033[0;31m"
GREEN="\033[0;32m"
NC="\033[0m" # No Color

STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|kts)$' || true)

if [[ -z "${STAGED_KOTLIN_FILES}" ]]; then
  echo -e "${GREEN}No Kotlin files staged. Skipping ktlint/detekt.${NC}"
  exit 0
fi

echo -e "${GREEN}Running ktlintCheck on staged Kotlin files...${NC}"
./gradlew ktlintCheck -q

echo -e "${GREEN}Running detekt on Kotlin sources...${NC}"
./gradlew detekt -q

if [[ $? -ne 0 ]]; then
  echo -e "${RED}Static analysis failed. Fix issues before committing.${NC}"
  exit 1
fi

echo -e "${GREEN}Static analysis passed. Proceeding with commit.${NC}"
exit 0
